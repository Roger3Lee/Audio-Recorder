# AudioRecorder OAuth2 å®ç°æ€»ç»“

æœ¬æ–‡æ¡£æ€»ç»“äº†AudioRecorderåº”ç”¨ä¸­OAuth2åè®®çš„å®Œæ•´å®ç°ã€‚

## ğŸ¯ å®ç°ç›®æ ‡

å®ç°æ ‡å‡†çš„OAuth2åè®®ç™»å½•ï¼Œæ”¯æŒå¤šä¸ªèº«ä»½æä¾›å•†ï¼Œç‰¹åˆ«é’ˆå¯¹GitHubè¿›è¡Œæµ‹è¯•ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

1. **OAuthLoginService** - OAuthç™»å½•æœåŠ¡ä¸»å…¥å£
2. **AuthorizationManager** - å•ä¸ªOAuthæä¾›å•†çš„æˆæƒç®¡ç†
3. **TokenManager** - ä»¤ç‰Œç®¡ç†å’Œè‡ªåŠ¨åˆ·æ–°
4. **LocalHttpServer** - æœ¬åœ°HTTPæœåŠ¡å™¨ï¼Œå¤„ç†OAuthå›è°ƒ
5. **SecureStorageManager** - å®‰å…¨ä»¤ç‰Œå­˜å‚¨
6. **ConfigurationService** - é…ç½®ç®¡ç†

### è®¾è®¡æ¨¡å¼

- **å•ä¾‹æ¨¡å¼**: ConfigurationService
- **å·¥å‚æ¨¡å¼**: OAuthé…ç½®åˆ›å»º
- **è§‚å¯Ÿè€…æ¨¡å¼**: äº‹ä»¶é©±åŠ¨çš„çŠ¶æ€é€šçŸ¥
- **ç­–ç•¥æ¨¡å¼**: ä¸åŒOAuthæä¾›å•†çš„å·®å¼‚åŒ–å¤„ç†

## ğŸ” OAuth2 æµç¨‹å®ç°

### 1. æˆæƒç æµç¨‹ (Authorization Code Flow)

```
ç”¨æˆ· â†’ åº”ç”¨ â†’ èº«ä»½æä¾›å•† â†’ ç”¨æˆ·æˆæƒ â†’ å›è°ƒ â†’ ä»¤ç‰Œäº¤æ¢ â†’ ç”¨æˆ·ä¿¡æ¯è·å–
```

### 2. è¯¦ç»†æ­¥éª¤

1. **å¯åŠ¨æˆæƒæµç¨‹**
   - ç”Ÿæˆéšæœºstateå‚æ•°
   - æ„å»ºæˆæƒURL
   - å¯åŠ¨æœ¬åœ°HTTPæœåŠ¡å™¨
   - æ‰“å¼€æµè§ˆå™¨

2. **ç”¨æˆ·æˆæƒ**
   - ç”¨æˆ·åœ¨èº«ä»½æä¾›å•†é¡µé¢å®Œæˆæˆæƒ
   - èº«ä»½æä¾›å•†é‡å®šå‘åˆ°æœ¬åœ°å›è°ƒåœ°å€

3. **å¤„ç†å›è°ƒ**
   - æœ¬åœ°HTTPæœåŠ¡å™¨æ¥æ”¶æˆæƒç 
   - éªŒè¯stateå‚æ•°é˜²æ­¢CSRFæ”»å‡»
   - ä½¿ç”¨æˆæƒç äº¤æ¢è®¿é—®ä»¤ç‰Œ

4. **è·å–ç”¨æˆ·ä¿¡æ¯**
   - ä½¿ç”¨è®¿é—®ä»¤ç‰Œè°ƒç”¨ç”¨æˆ·ä¿¡æ¯API
   - è§£æå¹¶å­˜å‚¨ç”¨æˆ·ä¿¡æ¯

5. **ä»¤ç‰Œç®¡ç†**
   - å®‰å…¨å­˜å‚¨ä»¤ç‰Œ
   - è‡ªåŠ¨åˆ·æ–°è¿‡æœŸä»¤ç‰Œ
   - ç™»å½•çŠ¶æ€æŒä¹…åŒ–

## ğŸ™ GitHub OAuth ç‰¹æ®Šå¤„ç†

### GitHub OAuth App ç‰¹æ€§

- **ä¸æ”¯æŒPKCE**: ä½¿ç”¨ä¼ ç»ŸOAuth2æµç¨‹
- **ä»¤ç‰Œæ ¼å¼**: è¿”å›form-urlencodedæ ¼å¼ï¼ŒéJSON
- **åˆ·æ–°ä»¤ç‰Œ**: ä¸æ”¯æŒï¼Œéœ€è¦é‡æ–°æˆæƒ
- **ä»¤ç‰Œè¿‡æœŸ**: è®¿é—®ä»¤ç‰Œ1å°æ—¶è¿‡æœŸ

### ç‰¹æ®Šå¤„ç†é€»è¾‘

```csharp
// GitHubä»¤ç‰Œå“åº”è§£æ
private TokenInfo? ParseGitHubTokenResponse(string responseContent)
{
    // è§£æform-urlencodedæ ¼å¼
    // è®¾ç½®é»˜è®¤è¿‡æœŸæ—¶é—´
    // å¤„ç†ç¼ºå°‘çš„å­—æ®µ
}
```

## ğŸ”§ é…ç½®ç®¡ç†

### é…ç½®æ–‡ä»¶ç»“æ„

```json
{
  "OAuth": {
    "GitHub": {
      "ClientId": "your-github-client-id",
      "ClientSecret": "your-github-client-secret",
      "RedirectUri": "http://localhost:8081/auth/callback",
      "Scopes": ["user", "user:email"]
    }
  }
}
```

### é…ç½®éªŒè¯

- æ£€æŸ¥Client IDå’ŒClient Secretæ˜¯å¦è®¾ç½®
- éªŒè¯å›è°ƒURLæ ¼å¼
- åŠ¨æ€åŠ è½½OAuthæä¾›å•†

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

### 1. CSRFé˜²æŠ¤

- æ¯æ¬¡æˆæƒç”Ÿæˆéšæœºstateå‚æ•°
- éªŒè¯å›è°ƒä¸­çš„stateå‚æ•°

### 2. ä»¤ç‰Œå®‰å…¨

- ä½¿ç”¨SecureStorageManagerå®‰å…¨å­˜å‚¨
- æ”¯æŒä»¤ç‰ŒåŠ å¯†å­˜å‚¨
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸä»¤ç‰Œ

### 3. ç½‘ç»œå®‰å…¨

- æœ¬åœ°HTTPæœåŠ¡å™¨ä»…ç›‘å¬localhost
- ä½¿ç”¨HTTPSè¿›è¡Œç”Ÿäº§ç¯å¢ƒé€šä¿¡
- éªŒè¯å›è°ƒURLåŒ¹é…

## ğŸ“± ç”¨æˆ·ç•Œé¢é›†æˆ

### ç™»å½•çŠ¶æ€æ˜¾ç¤º

- å®æ—¶æ˜¾ç¤ºç™»å½•çŠ¶æ€
- ç”¨æˆ·ä¿¡æ¯å±•ç¤ºï¼ˆå¤´åƒã€å§“åã€é‚®ç®±ï¼‰
- ç™»å½•/ç™»å‡ºæŒ‰é’®

### é”™è¯¯å¤„ç†

- å‹å¥½çš„é”™è¯¯æç¤º
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- è‡ªåŠ¨é‡è¯•æœºåˆ¶

## ğŸ§ª æµ‹è¯•å’ŒéªŒè¯

### æµ‹è¯•ç¨‹åº

åˆ›å»ºäº†ç‹¬ç«‹çš„OAuthæµ‹è¯•ç¨‹åº (`OAuthTest.cs`)ï¼Œæ”¯æŒï¼š

- å¤šæä¾›å•†ç™»å½•æµ‹è¯•
- ç™»å½•çŠ¶æ€æ¢å¤æµ‹è¯•
- ä»¤ç‰Œåˆ·æ–°æµ‹è¯•
- é”™è¯¯åœºæ™¯æµ‹è¯•

### è¿è¡Œæµ‹è¯•

```bash
# ä½¿ç”¨æ‰¹å¤„ç†æ–‡ä»¶
test_oauth.bat

# æˆ–ç›´æ¥è¿è¡Œ
dotnet run --project . --configuration Release
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. å¼‚æ­¥å¤„ç†

- æ‰€æœ‰ç½‘ç»œè¯·æ±‚ä½¿ç”¨async/await
- éé˜»å¡UIæ“ä½œ
- å¹¶å‘ä»¤ç‰Œåˆ·æ–°

### 2. ç¼“å­˜ç­–ç•¥

- ä»¤ç‰Œæœ¬åœ°ç¼“å­˜
- ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
- æ™ºèƒ½è¿‡æœŸæ£€æŸ¥

### 3. èµ„æºç®¡ç†

- åŠæ—¶é‡Šæ”¾HTTPè¿æ¥
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸèµ„æº
- å†…å­˜ä½¿ç”¨ä¼˜åŒ–

## ğŸ”„ æ‰©å±•æ€§è®¾è®¡

### æ·»åŠ æ–°çš„OAuthæä¾›å•†

1. å®ç°OAuthConfigé…ç½®
2. æ·»åŠ ç”¨æˆ·ä¿¡æ¯è·å–é€»è¾‘
3. æ³¨å†Œåˆ°OAuthLoginService
4. æ›´æ–°é…ç½®æ–‡ä»¶

### ç¤ºä¾‹ï¼šæ·»åŠ Microsoft OAuth

```csharp
public static class MicrosoftOAuthConfig
{
    public static OAuthConfig Default => new OAuthConfig
    {
        ClientId = "your-ms-client-id",
        ClientSecret = "your-ms-client-secret",
        AuthorizationEndpoint = "https://login.microsoftonline.com/common/oauth2/v2.0/authorize",
        TokenEndpoint = "https://login.microsoftonline.com/common/oauth2/v2.0/token",
        Scopes = new[] { "User.Read" },
        ProviderName = "Microsoft"
    };
}
```

## ğŸš€ éƒ¨ç½²è¯´æ˜

### å¼€å‘ç¯å¢ƒ

1. é…ç½®GitHub OAuthåº”ç”¨
2. æ›´æ–°appsettings.json
3. è¿è¡Œæµ‹è¯•ç¨‹åºéªŒè¯

### ç”Ÿäº§ç¯å¢ƒ

1. æ›´æ–°å›è°ƒURLä¸ºHTTPS
2. ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯
3. é…ç½®é˜²ç«å¢™è§„åˆ™
4. å¯ç”¨HTTPSè¯ä¹¦

## ğŸ“ ä½¿ç”¨è¯´æ˜

### 1. é…ç½®GitHub OAuth

å‚è€ƒ `README_GitHub_OAuth_Setup.md` æ–‡æ¡£

### 2. è¿è¡Œåº”ç”¨

```bash
# ç¼–è¯‘
dotnet build

# è¿è¡Œ
dotnet run

# æˆ–ç›´æ¥è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶
./bin/Release/net8.0-windows/win-x64/AudioRecorder.exe
```

### 3. ç™»å½•æµç¨‹

1. å¯åŠ¨åº”ç”¨
2. ç‚¹å‡»"GitHubç™»å½•"æŒ‰é’®
3. åœ¨æµè§ˆå™¨ä¸­å®Œæˆæˆæƒ
4. æŸ¥çœ‹ç™»å½•çŠ¶æ€

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **"redirect_uri_mismatch"**
   - æ£€æŸ¥GitHub OAuthåº”ç”¨é…ç½®
   - ç¡®è®¤å›è°ƒURLå®Œå…¨åŒ¹é…

2. **"invalid_client"**
   - éªŒè¯Client IDå’ŒClient Secret
   - æ£€æŸ¥é…ç½®æ–‡ä»¶æ ¼å¼

3. **æœ¬åœ°æœåŠ¡å™¨å¯åŠ¨å¤±è´¥**
   - æ£€æŸ¥ç«¯å£8081æ˜¯å¦è¢«å ç”¨
   - ç¡®è®¤é˜²ç«å¢™è®¾ç½®

### è°ƒè¯•æŠ€å·§

- å¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡º
- ä½¿ç”¨Fiddlerç­‰å·¥å…·ç›‘æ§ç½‘ç»œè¯·æ±‚
- æ£€æŸ¥æµè§ˆå™¨å¼€å‘è€…å·¥å…·

## ğŸ“š æŠ€æœ¯æ ˆ

- **.NET 8.0**: ä¸»è¦å¼€å‘æ¡†æ¶
- **WPF**: ç”¨æˆ·ç•Œé¢æ¡†æ¶
- **System.Text.Json**: JSONåºåˆ—åŒ–
- **HttpClient**: HTTPé€šä¿¡
- **HttpListener**: æœ¬åœ°HTTPæœåŠ¡å™¨

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡å®ç°å®Œå…¨ç¬¦åˆOAuth2æ ‡å‡†ï¼Œæä¾›äº†ï¼š

âœ… **å®Œæ•´çš„OAuth2æˆæƒç æµç¨‹**
âœ… **å¤šæä¾›å•†æ”¯æŒï¼ˆGitHubã€Googleï¼‰**
âœ… **å®‰å…¨çš„ä»¤ç‰Œç®¡ç†**
âœ… **è‡ªåŠ¨ç™»å½•çŠ¶æ€æ¢å¤**
âœ… **ç”¨æˆ·å‹å¥½çš„ç•Œé¢é›†æˆ**
âœ… **è¯¦ç»†çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—**
âœ… **å¯æ‰©å±•çš„æ¶æ„è®¾è®¡**
âœ… **å®Œæ•´çš„æµ‹è¯•å’ŒéªŒè¯**

è¯¥å®ç°å¯ä»¥ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œä¸ºAudioRecorderåº”ç”¨æä¾›äº†å®‰å…¨ã€å¯é çš„ç”¨æˆ·èº«ä»½éªŒè¯åŠŸèƒ½ã€‚
