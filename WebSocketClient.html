<!DOCTYPE html>
<html>

<head>
  <title>éŸ³é¢‘å½•åˆ¶ WebSocket å®¢æˆ·ç«¯</title>
  <meta charset="utf-8">
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }

    .control-section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #fafafa;
    }

    .control-section h3 {
      margin-top: 0;
      color: #555;
    }

    button {
      margin: 5px;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }

    .btn-primary {
      background-color: #007bff;
      color: white;
    }

    .btn-success {
      background-color: #28a745;
      color: white;
    }

    .btn-danger {
      background-color: #dc3545;
      color: white;
    }

    .btn-info {
      background-color: #17a2b8;
      color: white;
    }

    .btn-warning {
      background-color: #ffc107;
      color: black;
    }

    button:hover {
      opacity: 0.8;
    }

    input,
    select {
      margin: 5px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    #messages {
      border: 1px solid #ccc;
      height: 400px;
      overflow-y: scroll;
      padding: 10px;
      margin: 10px 0;
      background-color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .success {
      color: #28a745;
    }

    .error {
      color: #dc3545;
    }

    .info {
      color: #17a2b8;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-connected {
      background-color: #28a745;
    }

    .status-disconnected {
      background-color: #dc3545;
    }

    .status-recording {
      background-color: #ffc107;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: inline-block;
      width: 120px;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ™ï¸ éŸ³é¢‘å½•åˆ¶ WebSocket è¿œç¨‹æ§åˆ¶</h1>

    <!-- è¿æ¥æ§åˆ¶ -->
    <div class="control-section">
      <h3>ğŸ“¡ è¿æ¥æ§åˆ¶</h3>
      <div class="form-group">
        <label>æœåŠ¡å™¨åœ°å€:</label>
        <input type="text" id="serverUrl" value="ws://localhost:8080/ws" style="width: 250px;">
        <span id="connectionStatus">
          <span class="status-indicator status-disconnected"></span>æœªè¿æ¥
        </span>
      </div>
      <button class="btn-primary" onclick="connect()">ğŸ”— è¿æ¥</button>
      <button class="btn-danger" onclick="disconnect()">âŒ æ–­å¼€</button>
      <button class="btn-info" onclick="getStatus()">ğŸ“Š è·å–çŠ¶æ€</button>
    </div>

    <!-- å½•åˆ¶æ§åˆ¶ -->
    <div class="control-section">
      <h3>ğŸµ å½•åˆ¶æ§åˆ¶</h3>
      <div class="form-group">
        <label>å½•åˆ¶æ¨¡å¼:</label>
        <select id="recordMode">
          <option value="Mixed">æ··åˆæ¨¡å¼</option>
          <option value="Separate">åˆ†ç¦»æ¨¡å¼</option>
        </select>
      </div>
      <div class="form-group">
        <label>å½•åˆ¶æº:</label>
        <input type="checkbox" id="recordSystem" checked> ç³»ç»ŸéŸ³é¢‘
        <input type="checkbox" id="recordMic" checked> éº¦å…‹é£
      </div>
      <div class="form-group">
        <label>éº¦å…‹é£å¢ç›Š:</label>
        <input type="number" id="gainInput" value="2.0" step="0.1" min="0.1" max="8.0" style="width: 80px;">
        <span id="gainValue">2.0x</span>
      </div>
      <button class="btn-success" onclick="startRecording()">â–¶ï¸ å¼€å§‹å½•åˆ¶</button>
      <button class="btn-danger" onclick="stopRecording()">â¹ï¸ åœæ­¢å½•åˆ¶</button>
      <button class="btn-warning" onclick="setGain()">ğŸšï¸ è®¾ç½®å¢ç›Š</button>
    </div>

    <!-- é«˜çº§åŠŸèƒ½ -->
    <div class="control-section">
      <h3>âš™ï¸ é«˜çº§åŠŸèƒ½</h3>
      <button class="btn-info" onclick="getMicrophones()">ğŸ¤ è·å–éº¦å…‹é£åˆ—è¡¨</button>
      <button class="btn-warning" onclick="clearMessages()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <!-- æ¶ˆæ¯æ—¥å¿— -->
    <div class="control-section">
      <h3>ğŸ“ æ¶ˆæ¯æ—¥å¿—</h3>
      <div id="messages"></div>
    </div>
  </div>

  <script>
    let ws = null;
    let isConnected = false;
    let isRecording = false;

    function updateConnectionStatus(connected) {
      isConnected = connected;
      const statusElement = document.getElementById('connectionStatus');
      if (connected) {
        statusElement.innerHTML = '<span class="status-indicator status-connected"></span>å·²è¿æ¥';
      } else {
        statusElement.innerHTML = '<span class="status-indicator status-disconnected"></span>æœªè¿æ¥';
      }
    }

    function updateRecordingStatus(recording) {
      isRecording = recording;
      // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°å½•åˆ¶çŠ¶æ€æŒ‡ç¤ºå™¨
    }

    function connect() {
      const serverUrl = document.getElementById('serverUrl').value;
      if (!serverUrl) {
        addMessage('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€', 'error');
        return;
      }

      ws = new WebSocket(serverUrl);

      ws.onopen = () => {
        updateConnectionStatus(true);
        addMessage('âœ… WebSocketè¿æ¥æˆåŠŸ', 'success');
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleMessage(data);
        } catch (e) {
          addMessage('âŒ è§£ææ¶ˆæ¯å¤±è´¥: ' + event.data, 'error');
        }
      };

      ws.onerror = (error) => {
        addMessage('âŒ WebSocketè¿æ¥é”™è¯¯', 'error');
        updateConnectionStatus(false);
      };

      ws.onclose = () => {
        addMessage('ğŸ”Œ WebSocketè¿æ¥å·²å…³é—­', 'info');
        updateConnectionStatus(false);
        updateRecordingStatus(false);
      };
    }

    function disconnect() {
      if (ws) {
        ws.close();
      }
    }

    function handleMessage(data) {
      const icon = data.Success ? 'âœ…' : 'âŒ';
      const type = data.Success ? 'success' : 'error';

      switch (data.Command) {
        case 'connected':
          addMessage(`${icon} ${data.Message}`, type);
          if (data.Data) {
            updateRecordingStatus(data.Data.IsRecording);
            addMessage(`ğŸ“Š å½“å‰çŠ¶æ€ - å½•åˆ¶ä¸­: ${data.Data.IsRecording ? 'æ˜¯' : 'å¦'}, éº¦å…‹é£å¢ç›Š: ${data.Data.MicrophoneGain}x`, 'info');
          }
          break;

        case 'start_recording':
          addMessage(`${icon} ${data.Message}`, type);
          if (data.Success && data.Data) {
            updateRecordingStatus(data.Data.IsRecording);
            addMessage(`ğŸµ å½•åˆ¶å‚æ•° - æ¨¡å¼: ${data.Data.Mode}, ç³»ç»ŸéŸ³é¢‘: ${data.Data.RecordSystemAudio ? 'æ˜¯' : 'å¦'}, éº¦å…‹é£: ${data.Data.RecordMicrophone ? 'æ˜¯' : 'å¦'}`, 'info');
          }
          break;

        case 'stop_recording':
          addMessage(`${icon} ${data.Message}`, type);
          if (data.Data) {
            updateRecordingStatus(data.Data.IsRecording);
          }
          break;

        case 'get_status':
          addMessage(`${icon} ${data.Message}`, type);
          if (data.Data) {
            updateRecordingStatus(data.Data.IsRecording);
            addMessage(`ğŸ“Š ç³»ç»ŸçŠ¶æ€ - å½•åˆ¶ä¸­: ${data.Data.IsRecording ? 'æ˜¯' : 'å¦'}, éº¦å…‹é£å¢ç›Š: ${data.Data.MicrophoneGain}x, ç³»ç»ŸéŸ³é¢‘å¢ç›Š: ${data.Data.SystemAudioGain}x`, 'info');
          }
          break;

        case 'set_microphone_gain':
          addMessage(`${icon} ${data.Message}`, type);
          if (data.Data) {
            document.getElementById('gainValue').textContent = data.Data.MicrophoneGain + 'x';
          }
          break;

        case 'get_microphones':
          addMessage(`${icon} ${data.Message}`, type);
          if (data.Data && Array.isArray(data.Data)) {
            addMessage(`ğŸ¤ å¯ç”¨éº¦å…‹é£ (${data.Data.length}ä¸ª):`, 'info');
            data.Data.forEach((mic, index) => {
              addMessage(`   ${index + 1}. ${mic}`, 'info');
            });
          }
          break;

        case 'status_update':
          addMessage(`ğŸ“¢ ${data.Message}`, 'info');
          if (data.Data) {
            updateRecordingStatus(data.Data.IsRecording);
          }
          break;

        case 'error_occurred':
          addMessage(`ğŸ’¥ ç³»ç»Ÿé”™è¯¯: ${data.Message}`, 'error');
          break;

        default:
          addMessage(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data, null, 2)}`, type);
      }
    }

    function sendCommand(command, data = null) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        addMessage('âŒ è¯·å…ˆè¿æ¥WebSocketæœåŠ¡å™¨', 'error');
        return;
      }

      const message = { Command: command, Data: data };
      ws.send(JSON.stringify(message));
      addMessage(`ğŸ“¤ å‘é€å‘½ä»¤: ${command}`, 'info');
    }

    function startRecording() {
      const recordData = {
        RecordSystemAudio: document.getElementById('recordSystem').checked,
        RecordMicrophone: document.getElementById('recordMic').checked,
        Mode: document.getElementById('recordMode').value,
        MicrophoneGain: parseFloat(document.getElementById('gainInput').value)
      };
      sendCommand('start_recording', recordData);
    }

    function stopRecording() {
      sendCommand('stop_recording');
    }

    function getStatus() {
      sendCommand('get_status');
    }

    function setGain() {
      const gain = document.getElementById('gainInput').value;
      sendCommand('set_microphone_gain', gain);
    }

    function getMicrophones() {
      sendCommand('get_microphones');
    }

    function clearMessages() {
      document.getElementById('messages').innerHTML = '';
    }

    function addMessage(message, type = '') {
      const div = document.createElement('div');
      div.className = type;
      const time = new Date().toLocaleTimeString();
      div.textContent = `[${time}] ${message}`;
      const messagesDiv = document.getElementById('messages');
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // å¢ç›Šå€¼å®æ—¶æ›´æ–°
    document.getElementById('gainInput').addEventListener('input', function () {
      document.getElementById('gainValue').textContent = this.value + 'x';
    });

    // é¡µé¢åŠ è½½å®Œæˆæç¤º
    window.addEventListener('load', function () {
      addMessage('ğŸš€ WebSocketå®¢æˆ·ç«¯å·²å°±ç»ªï¼Œè¯·è¿æ¥åˆ°æœåŠ¡å™¨å¼€å§‹ä½¿ç”¨', 'info');
    });
  </script>
</body>

</html>