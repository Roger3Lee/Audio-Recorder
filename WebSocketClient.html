<!DOCTYPE html>
<html>

<head>
  <title>音频录制 WebSocket 客户端</title>
  <meta charset="utf-8">
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }

    .control-section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #fafafa;
    }

    .control-section h3 {
      margin-top: 0;
      color: #555;
    }

    button {
      margin: 5px;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }

    .btn-primary {
      background-color: #007bff;
      color: white;
    }

    .btn-success {
      background-color: #28a745;
      color: white;
    }

    .btn-danger {
      background-color: #dc3545;
      color: white;
    }

    .btn-info {
      background-color: #17a2b8;
      color: white;
    }

    .btn-warning {
      background-color: #ffc107;
      color: black;
    }

    button:hover {
      opacity: 0.8;
    }

    input,
    select {
      margin: 5px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    #messages {
      border: 1px solid #ccc;
      height: 400px;
      overflow-y: scroll;
      padding: 10px;
      margin: 10px 0;
      background-color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .success {
      color: #28a745;
    }

    .error {
      color: #dc3545;
    }

    .info {
      color: #17a2b8;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-connected {
      background-color: #28a745;
    }

    .status-disconnected {
      background-color: #dc3545;
    }

    .status-recording {
      background-color: #ffc107;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: inline-block;
      width: 120px;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>🎙️ 音频录制 WebSocket 远程控制</h1>

    <!-- 连接控制 -->
    <div class="control-section">
      <h3>📡 连接控制</h3>
      <div class="form-group">
        <label>服务器地址:</label>
        <input type="text" id="serverUrl" value="ws://localhost:8080/ws" style="width: 250px;">
        <span id="connectionStatus">
          <span class="status-indicator status-disconnected"></span>未连接
        </span>
      </div>
      <button class="btn-primary" onclick="connect()">🔗 连接</button>
      <button class="btn-danger" onclick="disconnect()">❌ 断开</button>
      <button class="btn-info" onclick="getStatus()">📊 获取状态</button>
    </div>

    <!-- 录制控制 -->
    <div class="control-section">
      <h3>🎵 录制控制</h3>
      <div class="form-group">
        <label>录制模式:</label>
        <select id="recordMode">
          <option value="Mixed">混合模式</option>
          <option value="Separate">分离模式</option>
        </select>
      </div>
      <div class="form-group">
        <label>录制源:</label>
        <input type="checkbox" id="recordSystem" checked> 系统音频
        <input type="checkbox" id="recordMic" checked> 麦克风
      </div>
      <div class="form-group">
        <label>麦克风增益:</label>
        <input type="number" id="gainInput" value="2.0" step="0.1" min="0.1" max="8.0" style="width: 80px;">
        <span id="gainValue">2.0x</span>
      </div>
      <button class="btn-success" onclick="startRecording()">▶️ 开始录制</button>
      <button class="btn-danger" onclick="stopRecording()">⏹️ 停止录制</button>
      <button class="btn-warning" onclick="setGain()">🎚️ 设置增益</button>
    </div>

    <!-- 高级功能 -->
    <div class="control-section">
      <h3>⚙️ 高级功能</h3>
      <button class="btn-info" onclick="getMicrophones()">🎤 获取麦克风列表</button>
      <button class="btn-warning" onclick="clearMessages()">🧹 清空日志</button>
    </div>

    <!-- 消息日志 -->
    <div class="control-section">
      <h3>📝 消息日志</h3>
      <div id="messages"></div>
    </div>
  </div>

  <script>
    let ws = null;
    let isConnected = false;
    let isRecording = false;

    function updateConnectionStatus(connected) {
      isConnected = connected;
      const statusElement = document.getElementById('connectionStatus');
      if (connected) {
        statusElement.innerHTML = '<span class="status-indicator status-connected"></span>已连接';
      } else {
        statusElement.innerHTML = '<span class="status-indicator status-disconnected"></span>未连接';
      }
    }

    function updateRecordingStatus(recording) {
      isRecording = recording;
      // 可以在这里更新录制状态指示器
    }

    function connect() {
      const serverUrl = document.getElementById('serverUrl').value;
      if (!serverUrl) {
        addMessage('请输入服务器地址', 'error');
        return;
      }

      ws = new WebSocket(serverUrl);

      ws.onopen = () => {
        updateConnectionStatus(true);
        addMessage('✅ WebSocket连接成功', 'success');
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleMessage(data);
        } catch (e) {
          addMessage('❌ 解析消息失败: ' + event.data, 'error');
        }
      };

      ws.onerror = (error) => {
        addMessage('❌ WebSocket连接错误', 'error');
        updateConnectionStatus(false);
      };

      ws.onclose = () => {
        addMessage('🔌 WebSocket连接已关闭', 'info');
        updateConnectionStatus(false);
        updateRecordingStatus(false);
      };
    }

    function disconnect() {
      if (ws) {
        ws.close();
      }
    }

    function handleMessage(data) {
      const icon = data.Success ? '✅' : '❌';
      const type = data.Success ? 'success' : 'error';

      switch (data.Command) {
        case 'connected':
          addMessage(`${icon} ${data.Message}`, type);
          if (data.Data) {
            updateRecordingStatus(data.Data.IsRecording);
            addMessage(`📊 当前状态 - 录制中: ${data.Data.IsRecording ? '是' : '否'}, 麦克风增益: ${data.Data.MicrophoneGain}x`, 'info');
          }
          break;

        case 'start_recording':
          addMessage(`${icon} ${data.Message}`, type);
          if (data.Success && data.Data) {
            updateRecordingStatus(data.Data.IsRecording);
            addMessage(`🎵 录制参数 - 模式: ${data.Data.Mode}, 系统音频: ${data.Data.RecordSystemAudio ? '是' : '否'}, 麦克风: ${data.Data.RecordMicrophone ? '是' : '否'}`, 'info');
          }
          break;

        case 'stop_recording':
          addMessage(`${icon} ${data.Message}`, type);
          if (data.Data) {
            updateRecordingStatus(data.Data.IsRecording);
          }
          break;

        case 'get_status':
          addMessage(`${icon} ${data.Message}`, type);
          if (data.Data) {
            updateRecordingStatus(data.Data.IsRecording);
            addMessage(`📊 系统状态 - 录制中: ${data.Data.IsRecording ? '是' : '否'}, 麦克风增益: ${data.Data.MicrophoneGain}x, 系统音频增益: ${data.Data.SystemAudioGain}x`, 'info');
          }
          break;

        case 'set_microphone_gain':
          addMessage(`${icon} ${data.Message}`, type);
          if (data.Data) {
            document.getElementById('gainValue').textContent = data.Data.MicrophoneGain + 'x';
          }
          break;

        case 'get_microphones':
          addMessage(`${icon} ${data.Message}`, type);
          if (data.Data && Array.isArray(data.Data)) {
            addMessage(`🎤 可用麦克风 (${data.Data.length}个):`, 'info');
            data.Data.forEach((mic, index) => {
              addMessage(`   ${index + 1}. ${mic}`, 'info');
            });
          }
          break;

        case 'status_update':
          addMessage(`📢 ${data.Message}`, 'info');
          if (data.Data) {
            updateRecordingStatus(data.Data.IsRecording);
          }
          break;

        case 'error_occurred':
          addMessage(`💥 系统错误: ${data.Message}`, 'error');
          break;

        default:
          addMessage(`📨 收到消息: ${JSON.stringify(data, null, 2)}`, type);
      }
    }

    function sendCommand(command, data = null) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        addMessage('❌ 请先连接WebSocket服务器', 'error');
        return;
      }

      const message = { Command: command, Data: data };
      ws.send(JSON.stringify(message));
      addMessage(`📤 发送命令: ${command}`, 'info');
    }

    function startRecording() {
      const recordData = {
        RecordSystemAudio: document.getElementById('recordSystem').checked,
        RecordMicrophone: document.getElementById('recordMic').checked,
        Mode: document.getElementById('recordMode').value,
        MicrophoneGain: parseFloat(document.getElementById('gainInput').value)
      };
      sendCommand('start_recording', recordData);
    }

    function stopRecording() {
      sendCommand('stop_recording');
    }

    function getStatus() {
      sendCommand('get_status');
    }

    function setGain() {
      const gain = document.getElementById('gainInput').value;
      sendCommand('set_microphone_gain', gain);
    }

    function getMicrophones() {
      sendCommand('get_microphones');
    }

    function clearMessages() {
      document.getElementById('messages').innerHTML = '';
    }

    function addMessage(message, type = '') {
      const div = document.createElement('div');
      div.className = type;
      const time = new Date().toLocaleTimeString();
      div.textContent = `[${time}] ${message}`;
      const messagesDiv = document.getElementById('messages');
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // 增益值实时更新
    document.getElementById('gainInput').addEventListener('input', function () {
      document.getElementById('gainValue').textContent = this.value + 'x';
    });

    // 页面加载完成提示
    window.addEventListener('load', function () {
      addMessage('🚀 WebSocket客户端已就绪，请连接到服务器开始使用', 'info');
    });
  </script>
</body>

</html>