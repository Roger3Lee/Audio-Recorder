# AudioRecorder 实时音频保存功能说明

## 🎯 功能概述

AudioRecorder现在实现了**真正的实时音频保存到硬盘**功能，确保录制的音频数据能够及时、安全地写入存储设备，避免因程序意外关闭而丢失录音数据。

## ✨ 核心特性

### 1. **实时数据写入**
- **50ms处理间隔** - 音频数据每50毫秒处理一次，确保低延迟
- **即时文件写入** - 使用`WaveFileWriter.WriteSamples()`实时写入音频数据
- **线程安全** - 使用锁机制确保多线程环境下的数据一致性

### 2. **智能文件刷新**
- **50ms刷新间隔** - 每50毫秒强制刷新文件缓冲区到硬盘
- **双重保障** - 结合系统缓冲和手动刷新，确保数据不丢失
- **性能优化** - 智能刷新策略，平衡实时性和系统性能

### 3. **实时状态监控**
- **写入速度监控** - 实时显示音频数据写入速度（KB/s）
- **数据量统计** - 显示总写入数据量和当前会话统计
- **状态反馈** - 每5秒输出一次保存状态信息

## 🏗️ 技术架构

### 核心组件

```csharp
// 实时保存优化参数
private const int RealTimeBufferSize = 1024;        // 实时缓冲区大小
private const int FlushIntervalMs = 50;             // 刷新间隔（毫秒）
private System.Threading.Timer? flushTimer;         // 文件刷新定时器
private readonly object fileWriteLock;              // 文件写入锁
private long totalBytesWritten;                     // 总写入字节数
private DateTime lastFlushTime;                     // 最后刷新时间
```

### 处理流程

```
音频捕获 → 缓冲区 → 音频处理 → 实时写入 → 文件刷新 → 硬盘存储
   ↓           ↓         ↓         ↓         ↓         ↓
WasapiCapture → Buffer → Pipeline → Writer → Flush → Disk
```

## 📊 性能指标

### 实时性指标
- **音频处理延迟**: ≤50ms
- **文件刷新间隔**: 50ms
- **数据写入延迟**: ≤100ms
- **硬盘同步**: 实时

### 存储效率
- **音频格式**: WAV (16kHz, 16bit, 单声道)
- **压缩比**: 无压缩，保证音质
- **文件大小**: 约32KB/秒
- **写入速度**: 实时监控显示

## 🔧 使用方法

### 1. **自动启动**
录音开始后，实时保存功能自动启动，无需手动配置。

### 2. **状态监控**
```csharp
// 获取实时保存状态
string status = recorder.GetRealTimeSaveStatus();
// 输出示例: "💾 实时保存中 - 写入速度: 32.5 KB/s, 总写入: 156.2 KB, 刷新间隔: 50ms"
```

### 3. **强制刷新**
```csharp
// 强制刷新音频文件到硬盘
recorder.ForceFlushAudioFiles();
```

### 4. **WebSocket集成**
实时保存状态通过WebSocket实时推送给远程客户端。

## 📁 文件存储

### 存储位置
```
桌面/
└── AudioRecordings/
    ├── SystemAudio_20241201_143022.wav    # 系统音频
    └── Microphone_20241201_143022.wav     # 麦克风音频
```

### 文件命名规则
- **格式**: `{音频类型}_{时间戳}.wav`
- **时间戳**: `yyyyMMdd_HHmmss`
- **示例**: `SystemAudio_20241201_143022.wav`

## 🚀 优化特性

### 1. **内存管理**
- **缓冲区优化** - 2秒音频缓冲区，平衡内存使用和实时性
- **垃圾回收友好** - 及时释放音频处理资源
- **内存泄漏防护** - 完整的资源清理机制

### 2. **错误处理**
- **异常捕获** - 捕获并处理所有音频处理异常
- **自动恢复** - 音频错误后自动尝试恢复
- **状态反馈** - 详细的错误信息和状态报告

### 3. **性能监控**
- **实时统计** - 写入速度、数据量、处理延迟
- **资源监控** - CPU使用率、内存占用、磁盘I/O
- **性能日志** - 详细的性能数据记录

## 📈 性能对比

### 优化前 vs 优化后

| 指标 | 优化前 | 优化后 | 提升 |
|------|--------|--------|------|
| 处理间隔 | 100ms | 50ms | **2x** |
| 文件刷新 | 无 | 50ms | **∞** |
| 数据丢失风险 | 高 | 极低 | **显著** |
| 实时性 | 一般 | 优秀 | **2x** |
| 系统稳定性 | 一般 | 优秀 | **显著** |

## 🔍 故障排除

### 常见问题

#### 1. **写入速度慢**
- 检查硬盘性能
- 确认磁盘空间充足
- 检查杀毒软件是否干扰

#### 2. **音频文件损坏**
- 检查磁盘空间
- 确认程序正常关闭
- 验证音频驱动

#### 3. **性能下降**
- 降低刷新频率
- 增加缓冲区大小
- 检查系统资源

### 调试信息
```csharp
// 启用详细日志
System.Diagnostics.Debug.WriteLine($"音频缓冲区 - 系统: {systemBuffer.Length}样本");
System.Diagnostics.Debug.WriteLine($"实时处理间隔: {intervalMilliseconds}ms");
System.Diagnostics.Debug.WriteLine($"文件刷新间隔: {FlushIntervalMs}ms");
```

## 🎉 总结

AudioRecorder的实时音频保存功能提供了：

1. **真正的实时性** - 50ms处理间隔，确保低延迟
2. **数据安全性** - 双重刷新机制，防止数据丢失
3. **性能监控** - 实时状态反馈，便于监控和调试
4. **系统稳定性** - 完善的错误处理和资源管理
5. **用户友好** - 自动启动，无需手动配置

这个功能确保了你的录音数据能够安全、实时地保存到硬盘，即使在程序意外关闭的情况下也不会丢失重要的录音内容！🎯
